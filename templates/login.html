{% extends "base.html" %}
{% block content %}

<div class="auth">
  <div class="auth__card card">
    <div class="auth__header">
      <h1>Sign in</h1>
      <p>Use Google to access ordering and your order history.</p>
    </div>

    <button id="googleBtn" class="btn btn--primary btn--full" type="button">
      <span class="g-icon" aria-hidden="true"></span>
      Continue with Google
    </button>

    <div class="auth__meta">
      <div id="status" class="status status--muted">Not signed in.</div>
      <div id="error" class="status status--error" style="display:none;"></div>
    </div>

    <p class="auth__small">You’ll be redirected back to the home page after login.</p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsPscAEUG-qyjIs8J_x3NQ6050KPwM-qA",
    authDomain: "sdassignment-ddfd7.firebaseapp.com",
    projectId: "sdassignment-ddfd7",
    appId: "1:300372904172:web:25b5c95a53951a4ec47dc9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const btn = document.getElementById("googleBtn");
  const statusEl = document.getElementById("status");
  const errorEl = document.getElementById("error");

  function setStatus(msg) { statusEl.textContent = msg; }
  function showError(msg) {
    errorEl.style.display = "block";
    errorEl.textContent = msg;
  }
  function clearError() {
    errorEl.style.display = "none";
    errorEl.textContent = "";
  }

  btn.addEventListener("click", async () => {
    clearError();
    btn.disabled = true;
    btn.classList.add("is-loading");
    setStatus("Opening Google sign-in…");

    try {
      const result = await signInWithPopup(auth, provider);
      setStatus("Creating server session…");

      const idToken = await result.user.getIdToken();
      const res = await fetch("/sessionLogin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idToken })
      });

      const json = await res.json().catch(() => ({}));
      if (!res.ok || !json.success) {
        throw new Error(json.error || "Login failed");
      }

      setStatus("Signed in. Redirecting…");
      window.location.href = "/";

    } catch (e) {
      setStatus("Not signed in.");
      showError(e.message || String(e));
    } finally {
      btn.disabled = false;
      btn.classList.remove("is-loading");
    }
  });
</script>

{% endblock %}
